# hegel-pm

Project manager for Hegel projects with web UI. Auto-discovers projects, visualizes workflow states, provides unified dashboard.

## Status

**Current**: Multi-view UI with all-projects dashboard and per-project workflow detail (collapsible workflows/phases)
**Next**: Enhanced UI features (graphs/trends, search/filtering)

## Architecture

### Core Components

**Discovery Engine** (`src/discovery/`)
- Filesystem-based project discovery
- Workflow state and metrics extraction via hegel-cli library
- Cache persistence for fast subsequent loads
- See `src/discovery/CODE_MAP.md` for detailed documentation

**Data Layer** (`src/data_layer/`)
- Message-passing worker pool for async I/O operations
- Lock-free response caching with DashMap (pre-serialized JSON)
- Parallel cache misses via tokio::spawn
- Zero blocking I/O in HTTP handlers
- See `src/data_layer/CODE_MAP.md` for architecture details

**HTTP Backends** (`src/http/`)
- Pluggable backend architecture (warp or axum)
- Compile-time selection via feature flags
- Both backends delegate to data layer worker pool
- See `src/http/CODE_MAP.md` for backend implementations

**Web Server** (`src/main.rs` with `server` feature)
- HTTP server on `localhost:3030` with swappable backend
- Default: warp-backend (can switch to axum-backend via features)
- Serves Sycamore WASM UI bundle (built by trunk to `static/`)
- JSON API endpoints:
  - `/api/projects` - Lightweight project list (name + workflow_state only)
  - `/api/projects/{name}/metrics` - ProjectInfo with summary + workflow detail breakdowns
  - `/api/all-projects` - Aggregate metrics across all discovered projects
- Archive-aware metrics: includes archived workflows + live data

**Web UI** (Sycamore + WASM in `src/client/`)
- Multi-view reactive dashboard with type-safe routing (View enum)
- All-projects aggregate view with cross-project metrics
- Per-project workflow detail with collapsible workflows/phases
- Built with Trunk bundler (outputs to `static/`)

**Dependencies**
- `hegel-cli` (path dependency) - All .hegel data access via library API
- `warp` (optional, default) - Async web server backend
- `axum` (optional) - Alternative async web server backend
- `sycamore` - Reactive web UI framework (WASM-compiled)
- `tokio` - Async runtime for worker pool and message passing
- `dashmap` - Lock-free concurrent HashMap for response caching

## Usage

### CLI

```bash
# Start web server and open browser (default)
hegel-pm

# Discovery commands (new subcommand structure)
hegel-pm discover list              # List all projects
hegel-pm discover show <name>       # Show single project details
hegel-pm discover all               # Full table with metrics

# Run hegel commands across all projects (xargs-style)
hegel-pm hegel status               # Run 'hegel status' on each project
hegel-pm hegel analyze              # Run 'hegel analyze' on each project
hegel-pm hegel analyze --fix-archives --dry-run  # Dry-run archive fix

# Legacy flags (deprecated, use 'discover list' instead)
hegel-pm --discover
hegel-pm --discover --refresh
```

**Build from source:**
```bash
# Default build (warp backend)
cargo build --release --bin hegel-pm --features server
./target/release/hegel-pm

# With axum backend
cargo build --release --bin hegel-pm --no-default-features --features server,axum-backend
```

**WASM UI development:**
```bash
trunk serve  # Hot reload at localhost:8080
trunk build --release  # Production build to static/
```

**Build artifacts:**
```bash
# Source template with CSS styles
./index.html  # Tracked in git

# Generated build artifacts (ignored by git)
static/index.html   # Generated by trunk build
static/*.js         # WASM bindings
static/*.wasm       # WASM blobs
```

Developers must run `trunk build` after pulling to generate `static/` artifacts.

### Discovery API (Library Usage)

```rust
use hegel_pm::discovery::{DiscoveryConfig, DiscoveryEngine};

// Create configuration
let config = DiscoveryConfig::default(); // Scans ~/Code

// Create engine
let engine = DiscoveryEngine::new(config)?;

// Get projects (uses cache if available)
let projects = engine.get_projects(false)?;

// Force refresh (bypass cache)
let projects = engine.get_projects(true)?;
```

### Configuration

Default configuration:
- **Root directories**: `~/Code`
- **Max depth**: 10 levels
- **Exclusions**: `node_modules`, `target`, `.git`, `vendor`
- **Cache location**: `~/.config/hegel-pm/cache.json`

Custom configuration:
```rust
let config = DiscoveryConfig::new(
    vec![PathBuf::from("/custom/path")],
    5,  // max depth
    vec!["build".to_string()],  // additional exclusions
    PathBuf::from("/tmp/cache.json"),
);
```

## Development

### Scripts

**Build & Test (Preferred):**
```bash
./scripts/test.sh                      # Build + test everything (default)
./scripts/test.sh --exclude frontend   # Backend only (skip WASM)
./scripts/test.sh --exclude backend    # Frontend only (skip cargo)
```

Use this for:
- Quick iteration during development
- Verifying changes without starting the server
- CI/CD pipelines

**Server Management:**
```bash
./scripts/restart-server.sh              # Backend only (fast)
./scripts/restart-server.sh --frontend   # Backend + frontend (full rebuild)
```

This script:
1. Stops any running hegel-pm server
2. Rebuilds backend/frontend (optional)
3. Starts fresh server with full logging (cache status, request timing)

Use this when:
- You need to see server logs with timing information
- Server is behaving unexpectedly or UI has stale WASM
- After changes that require viewing in browser

**Manual Commands:**
```bash
cargo test                  # Run all tests
cargo test discovery        # Run discovery module tests only
cargo test --features server  # Run with server feature enabled
```

Coverage: 31.64% (target: ≥80%, enforced by pre-commit hook)

### Project Structure

```
hegel-pm/
├── src/
│   ├── discovery/     # Project discovery engine
│   │   └── CODE_MAP.md    # Module structure documentation
│   ├── data_layer/    # Worker pool and caching
│   │   └── CODE_MAP.md    # Data layer architecture
│   ├── http/          # HTTP backend abstraction
│   │   ├── warp_backend.rs   # Warp implementation
│   │   ├── axum_backend.rs   # Axum implementation
│   │   └── CODE_MAP.md       # Backend documentation
│   ├── client/        # Sycamore WASM UI
│   ├── cli/           # CLI commands
│   ├── lib.rs
│   ├── main.rs
│   └── CODE_MAP.md    # Source structure overview
├── index.html         # Trunk build template (WASM entry point)
├── static/            # Built WASM output (served by web server)
├── .ddd/
│   └── feat/
│       └── swappable_backend/
│           ├── SPEC.md    # Feature specification
│           ├── PLAN.md    # Implementation plan
│           └── HANDOFF.md # Implementation handoff
└── README.md
```

## Future Work

1. **Enhanced UI Features**:
   - Token usage graphs and trends over time
   - Project health indicators and alerts
   - Search, filtering, and sorting across workflows
   - Phase-level detail expansion (show individual events/commands)
2. **CLI Commands** - `hegel-pm scan`, `hegel-pm serve`, `hegel-pm status`
3. **Live Updates** - File watching for real-time state synchronization (optional)
4. **Team Features** - Multi-user support for commercial version (data model ready)

## Error Handling

All errors include context with file paths for debugging:

- **Permission denied**: Logged, scan continues with accessible directories
- **Invalid state data**: Project included with error flag, marked for user attention
- **Missing cache**: Triggers fresh scan automatically
- **Invalid configuration**: Caught at engine creation with specific validation errors

## Performance

- **Initial scan**: <2 seconds for typical workspace (10-20 projects)
- **Worker pool**: Parallel I/O with configurable worker count (default: num_cpus * 2)
- **Response caching**: Lock-free reads via DashMap, pre-serialized JSON
- **Cache hits**: <1ms (zero deserialization, direct byte serving)
- **Cache misses**: Parallel loading via tokio::spawn
- **Metrics API response**: Fast (leverages pre-computed archive totals)
  - Project list: Minimal payload (name + workflow_state only, ~60-80% reduction)
  - Metrics: Pre-computed aggregates (total_all_tokens computed on backend)
- **Archive-aware**: Includes full project history (archived + live workflows)
- **Memory**: Bounded (lazy loading via hegel-cli library)
- **HTTP backends**: Both warp and axum delegate to same optimized data layer

## Integration with hegel-cli

hegel-pm depends on hegel-cli as a library for all .hegel data access:
- `hegel::storage::FileStorage` - State data extraction
- `hegel::storage::{State, WorkflowState}` - Type definitions
- `hegel::metrics::parse_unified_metrics` - Archive-aware metrics aggregation
  - Merges archived workflows with live data
  - Uses pre-computed totals from archive files
  - Includes git metrics backfilled via `hegel analyze --fix-archives`

**Abstraction boundary**: hegel-pm never directly reads .hegel files. All data access goes through hegel-cli's library API. The underlying storage format (JSON, JSONL, archives, SQLite, etc.) is completely opaque to hegel-pm.

## License

SSPL-1.0
